网关
========

外观概览
-----------

网关面板
-----------

按键操作
-----------

开启AP
^^^^^^^^^^

   #. 网关通电后，持续按下按键大于10秒
   #. 当\ **STATE**\ 指示灯亮起\ **红色**\ 后松开按键, 即可开启网关AP
   #. 搜索并连接wifi\ **ws-agw01-ap**\ 可连接至网关AP
   #. 当按键持续时长大于35s后，操作被取消

   *\* 网关提供AP功能，但连接后不能够通过此AP上网，仅能与网关通信*

关闭AP
^^^^^^^^^^

   * AP开启后(STATE指示灯亮起红色)，再次按下按键，保持2秒钟后松开按键，即可关闭网关的AP
   * AP关闭后，将不能搜索到名为\ **ws-agw01-ap**\ 的wifi热点
   * 当按键持续时长大于35s后，操作被取消

启动网关配对
^^^^^^^^^^^^^^

   #. 网关通电后，持续按下按键大于3秒
   #. 当\ **SYS**\ 指示灯快闪\ **绿色**\ 后松开按键, 即可开启网关配对功能   
   * 当按键持续时长大于35s后，操作被取消

关闭网关配对
^^^^^^^^^^^^^^

   * 网关配对功能开启后(SYS指示灯快速闪烁绿色)，再次按下按键，保持2秒钟后松开按键，即可关闭网关的配对功能
   * 配对功能开启5分钟后，将自动关闭
   * 网关配对功能关闭后，**SYS**\ 指示灯呈绿色慢闪
   * 当按键持续时长大于35s后，操作被取消

重启网关
^^^^^^^^^^

   * 网关通电后，按下按键持续20秒以上，当\* SYS、NET、STATE**\ 三颗指示灯同时闪烁后松开按键，网关将执行重启
   * 当按键持续时长大于35s后，操作被取消

恢复出厂
^^^^^^^^^^
   * 方式一: 网关通电后，按下按键持续30秒以上，当\* SYS、NET、STATE**\ 三颗指示灯同时常亮后松开按键，网关将执行恢复出厂（当按键持续时长大于35s后，操作被取消）
   * 方式二: 网关通电前，持续按下按键。 通电后继续保持3-8秒，，当\* SYS、NET、STATE**\ 三颗指示灯同时常亮后，网关将执行恢复出厂（操作不能取消）
   * 当前恢复出厂功能，仅对网络配置恢复出厂

网关联网
-----------

网络能力
^^^^^^^^^^^

   网关同时配备WIFI模块和有线网口，即可通过wifi或有线网与路由器相连。联网后网关可与平台通信,上传用电数据和接收平台下发的控制。
   联网期间需特别留意路由器的DHCP配置，通常家用路由器默认情况为新连接的设备动态分配IP地址，可能发生网关重启后得到了新的IP地址，用户继续访问上次的IP地址将会访问失败。
   当网关被分配了新IP后，可登录路由器页面查找网关设备的当前IP地址。
   对于网关的IP通常做法有:

       #. 网关与路由器连接成功后，在路由器页面的相关设置中，将当前网关的IP地址设置为静态地址.（推荐）
       #. 在网关的配置页面，将自己的IP指定为静态IP，（慎重使用: 当路由器已将相同的IP分配给其它设备时， 会因为IP冲突导致网关通信失败）。

WIFI-AP
++++++++++

      网关支持wifi-ap功能，即网关能够提供wifi热点，供电脑/手机连接，此后通过浏览器访问网关的web即可对网关的配置，包括连接互联网的配置。

      网关AP[#ap_limit]_:, 网关AP功能主要用于方便电脑/手机打开网关WEB，对网关配置和管理工作。不支持通过AP流量转发，即不支持通过网关AP连接互联网。

      * AP开启[#ap_limit]_: 按键位置，参考\ :ref:`网关简介`\ 。按下\ **SET**\ 并持续至少10秒，直到\ **STATE**\ 灯显示\ **红色**\ 常亮后松开按键。
      * 连接AP[#ap_limit]_: 电脑或手机搜索WiFi *ws-agw01-ap* 并连接。

WIFI-STA
++++++++++

有线网络
++++++++++

4G_LTE
++++++++++


网络优选
^^^^^^^^^^^

   #. 当网关开启了ETH、WIFI-STA、4G 其中任意两个网络，网关将按照 ETH > wifi-sta > 4G 的优先顺序联网。

      例如: 

      * 同时开启了ETH 、4G, 且二者均能够联外网，网关将使用ETH与平台进行通信
      * 同时开启了WIFI-STA 、4G, 且二者均能够联外网，网关将使用WIFI-STA与平台进行通信
      * 同时开启了WIFI-STA 、ETH, 且二者均能够联外网，网关将使用ETH与平台进行通信

   #. 多网同开情况下，较高优先级网口断开连接或与外网不同。网关将自动按照优先级顺序选择能够与外网联通的网口用作通信。

      例如:

      * 同时开启了WIFI-STA 、ETH, 且二者均能够联外网，网关将使用ETH与平台进行通信
      * 当ETH网线断开或不通外网发生后，网关将自动选择WIFI-STA作为通信网口

   *\*网口切换后，可能导致平台短时间与网关通信失败，网络良好的情况下约2分钟可通过新网口恢复通信*


网络配置
^^^^^^^^^^

   登录网关web后，单击左侧栏“参数配置”，在WIFI页面中输入周边可用的WIFI名称(SSID), 输入密码, 最后单击 "提交"， 网关通过wifi连接路由器配置完毕。
            
               .. figure:: ../../_static/images/gateway/gw_network_conf.jpg
                        :width: 80%

   *\*注：网关连接无线路由器过程中，电脑与网关的连接可能出现短时断开(<30秒), 配网完成后，请检查电脑与网关wifi连接，确认已连接后再刷新网页。*

   * 如上图所示，WIFI按钮的右侧显示了IP地址 192.168.2.101 即为网关连接上了路由器.
   * 关闭网关的AP: 网关联网成功后，即可关闭网关的AP功能: 按下网关面板中的 **SET** 按键，持续约1秒钟，待\ **STATE**\ 灯的红色消失松开按键，网关的AP功能已关闭。
   * 通过路由器访问网关: 将电脑的WiFi连接至网关所连路由器，在浏览器中输入http://192.168.2.101 即可访问网关的WEB。

网关登录
-----------

      * *关与访问地址:*\  电脑与网关连接方式不同，访问地址则不同。
         
         - 通过网关AP连接，访问地址为 http://192.168.20.1。 
         - 通过网线连接, 访问地址为 http://192.168.30.1 (此为出厂地址，如有修改则无效)

      * 参考\ 网络设置_\ 连接电脑的wifi到网关ap
      * 打开电脑浏览器，访问 http://192.168.20.1 ，将会打开网关的WEB， 如下图所示:

         .. figure:: ../../_static/images/gateway/weblogin.jpg
            :width: 80%
 
      * 输入密码，按下回车键，可以登录网关。

         .. figure:: ../../_static/images/gateway/gw_home.jpg
            :width: 80%

   登录网关：当网关与路由器连接后，可通过网关的ip地址远程登录。如网关的IP地址为 192.168.0.100, 在浏览器中输入 http://192.168.0.100 即可打开网关服务。

设备管理
-----------

CRUD
^^^^^^^^^

断路器更换
^^^^^^^^^^^^

断路器升级
^^^^^^^^^^^^^
参考\ :ref:`断路器升级`\ 

断路器属性配置
^^^^^^^^^^^^^^^

断路器异常
^^^^^^^^^^^^^
   #. 过流、过压、欠压、漏电 ...

LED状态汇总
--------------

未完待续 ...

#. SYS灯

   * 正常运行:
   * 配对:

#. NET灯
   
   * 平台连接:

#. STATE灯

   * AP

#. SYS+NET+STATE 灯

   * 恢复出厂: 
   * 设备重启:   

网关升级
------------

      #. 进入网关，单击左侧栏"网管升级", 单击\ **选择文件**
            .. figure:: ../../_static/images/gateway/gw_upgrade_01.jpg
               :width: 80%

               网关升级
      
      #. 选择升级文件
            .. figure:: ../../_static/images/gateway/gw_upgrade_02.jpg
               :width: 80%

               选择文件

      #. 单击\ **升级** 按钮，等待进度条完成，等待页面提示。
            .. figure:: ../../_static/images/gateway/gw_upgrade_03.jpg
               :width: 80%

               正在升级

      #. 升级完成后，网关web页面弹框
            
            .. figure:: ../../_static/images/gateway/gw_upgrade_04.jpg
               :width: 80%

               升级完成
            
      #. 网关启动后，进入\ **网关升级** 页面，展示新固件版本号 即按钮\ **应用版本** 
            .. figure:: ../../_static/images/gateway/gw_upgrade_05.jpg
               :width: 80%

      #. \ **应用版本**\ 按钮按下后，刚刚升级的固件生效且重启后依旧生效。如没有按下，则重启后，网关固件将回退到上一版本。

定时重启
---------
    
    **版本 >= 02_12**

    网关启动后，将每间隔12小时重启一次。

---

.. [#ap_limit] 网关AP的应用限制: (1)网关AP与STA同时开启，在按下“提交”或者网关启动后可能出现短时(20秒) 网络不稳定，即电脑连接网关AP时可能出现断连或访问速度变慢。(2)网关AP与STA同时开启后，网关STA连接路由器wifi 仅尝试3次，全部失败后将不再重连。